def check_click_from_browser(request, token):
    if request.method == "GET":
        headers = dict(request.headers)
        sec_fetch_site = headers["sec-fetch-site"]
        print(f"link visited with GET + sec-fetch-site: {sec_fetch_site}")
        return Title("Human verification"), Main(
            P("Click below to proceed (bots can't do this):"),
            Button("âœ… Yes, I'm human - Continue", 
                onclick="humanProceed()",
                style="font-size: 18px; padding: 12px;"),
            Script(f"""
                let clickCount = 0;
                function humanProceed() {{
                    clickCount++;
                    if (clickCount === 1) {{
                        // First click: show confirmation
                        document.querySelector('p').innerHTML = 'Great! One more click to verify.';
                        return;
                    }}
                    // Second deliberate click: proceed
                    window.location.href = '/authenticate_link/{token}';
                }} """ 
            ),
            cls="container")
    else:
        print("ignoring non GET (HEAD) html method")
        return "ignoring non GET html method"

def authenticate_link(session, token, users):
    nowstr = f"'{datetime.now()}'"
    try:
        user = users("magic_link_token = ? AND magic_link_expiry > ?", (token, nowstr))[0]
        usermail = user.email
        session['auth'] = usermail
        session['role'] = user.role_name
        users.update(email= user.email, magic_link_token= None, magic_link_expiry= None, is_active= True)
        print(f"{usermail} just got connected")
        return RedirectResponse('/dashboard')
    except IndexError:
        print("Invalid or expired magic link")
        return "Invalid or expired magic link"

