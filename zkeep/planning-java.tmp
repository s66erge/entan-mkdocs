            let pendingFetch = null;

            window.addEventListener('beforeunload', (e) => {
                // Show browser dialog FIRST
                e.preventDefault();
                e.returnValue = 'Save session state before leaving?';

                // Store fetch for later (can't execute during dialog)
                pendingFetch = () => fetch('/planning/set_free', {method: 'GET'});
            });

            // Listen for user response via visibilitychange (works after dialog)
            document.addEventListener('visibilitychange', () => {
                if (document.visibilityState === 'hidden' && pendingFetch) {
                    pendingFetch();
                    pendingFetch = null;
                }
            });

            // Fallback: pagehide (more reliable)
            window.addEventListener('pagehide', () => {
                if (pendingFetch) {
                    navigator.sendBeacon('/planning/set_free', '');  // Guaranteed delivery
                    pendingFetch = null;
                }

            });

