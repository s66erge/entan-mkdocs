{"config":{"lang":["en"],"separator":"[\\s\\-]+","pipeline":["stopWordFilter"],"fields":{"title":{"boost":1000.0},"text":{"boost":1.0},"tags":{"boost":1000000.0}}},"docs":[{"location":"","title":"Home","text":"<p>You will find here the documentation for:</p> <ul> <li>the architecture for the gong system </li> <li>the pyton code for the 'players' in the centers</li> <li>the python + fastHTML code for the central app on the web</li> <li>the info and python code to obtain a center schedule from dhamma.org</li> <li>the setup and deploy tools</li> </ul>"},{"location":"architecture/aintro/","title":"Overall architecture","text":"<p>TODO detail overall architecture.</p> <ul> <li>the 'players' : local machine(s) in each centers</li> <li>the central web app to modify the plannings</li> </ul>"},{"location":"architecture/data-design/","title":"Database design","text":""},{"location":"architecture/data-design/#gong-databases","title":"Gong databases","text":"<p>One gong database is used to store the gong planning data for each center. Each gong database name is referenced in the CENTERS table in the Admin database below. All gong databases have the same structure detailed here below, but their content will vary from center to center.</p> <p>As of today, this app is managing the gong planning for:</p> <ul> <li>Dhamma Mahi (mahi.db)</li> <li>Dhamma Pajjota (pajjota.db)</li> </ul> <p>TODO describe the entities</p> <pre><code>erDiagram\n\n    COMING_PERIODS  }o--|| PERIOD_TYPES : \"is\"\n    COMING_PERIODS { \n        date start_date PK\n        string period_type FK \n   }\n\n    PERIOD_TYPES { \n        string period_type PK \"e.g.: '10 days', 'Service','Trust WE' ...\"\n        string struct_table \"name of the STRUCTURE table\"\n        string tt_table \"name of the TIMINGS table\"\n    }\n\n    PERIOD_TYPES ||--|| STRUCTURE : \"has this structure table\"\n    STRUCTURE {\n        int day_sequence PK \"sequence of day: 0, 1, 2, ...\"\n        string day_type FK \"'day 0', 'course day', 'last day'\"\n        }\n\n    PERIOD_TYPES ||--|| TIMINGS : \"has timings in this table\"\n    STRUCTURE  }o--o{ TIMINGS : \"day type has these timings\"\n    TIMINGS {\n        string day_type FK\n        time gong_time\n        int gong_sound\n        boolean automatic_gong\n        string gong_description\n    }</code></pre>"},{"location":"architecture/data-design/#admin-database","title":"Admin database","text":"<p>The admin database is used to manage users, centers, and planners for gong planning. It has the following entities:</p> <p>ROLES: - admin for modifying USERS / CENTERS / PLANNERS, and also gong planning  - user for gong planning only</p> <p>USERS: - authenticated by sending a \"magic link\" to their email address : see \"authenticate.md\"</p> <p>CENTERS: - with the gong database name for this center</p> <p>PLANNERS: - indicates which user(s) can modify the gong planning of which center </p> <pre><code>erDiagram\n\n    ROLES { \n        string role_name PK\n        text description\n    }\n\n    USERS  }o--|| ROLES : \"has role\"\n    USERS {\n        string email PK\n        string name\n        string role_name FK\n        string magic_link_token\n        timestamp magic_link_expiry\n        boolean is_active\n    }\n\n    CENTERS {\n        string center_name PK\n        string gong_db_name\n    }\n\n    USERS ||--o{ PLANNERS : creates\n    PLANNERS }o--|| CENTERS : for\n    PLANNERS {\n        string user_email PK, FK\n        string center_name PK, FK\n    }</code></pre>"},{"location":"architecture/ui-archi/","title":"UI architecture","text":"<p>The UI architecture is based on htmx (https://htmx.org/), a JavaScript library that extends HTML with custom attributes to add dynamic web features directly in HTML without needing large JavaScript frameworks.</p>"},{"location":"architecture/ui-archi/#key-features-of-htmx","title":"Key Features of htmx:","text":"<ul> <li>Adds attributes like hx-get, hx-post, hx-put, hx-delete, and hx-patch to HTML elements that trigger AJAX requests on certain user actions (click, submit, change).</li> <li>Enables partial HTML updates by swapping server responses into parts of the current page DOM, avoiding full page reloads.</li> <li>Supports event modifiers, CSS transitions, WebSockets, and Server-Sent Events through HTML attributes.</li> <li>Promotes a server-driven application model: the server returns HTML fragments rather than JSON, making UI updates simpler with less client-side JavaScript.</li> </ul>"},{"location":"gong-players/intro/","title":"Intro","text":"<p>TODO document players</p>"},{"location":"gong-web-app/0-gong-prog/","title":"Gong main program","text":""},{"location":"gong-web-app/0-gong-prog/#program-start","title":"Program start","text":"file: main.py<pre><code>import os\nimport sys\nimport shutil\nfrom functools import wraps\nfrom fasthtml.common import *\n# from starlette.testclient import TestClient\n\nfrom libs import * \nfrom libs.auth import admin_required\n\nif len(sys.argv) &gt; 1:\n    environ = sys.argv[1]\nelse:\n    environ = \"dev\"\n\ncss = Style(':root {--pico-font-size: 95% ; --pico-font-family: Pacifico, cursive;}')\n\ndef before(req, session):\n   auth = req.scope['auth'] = session.get('auth', None)\n   if not auth: return RedirectResponse('/login', status_code=303)\n\nbware = Beforeware(before, skip=[r'/favicon\\.ico', r'/static/.*', r'.*\\.css', '/login','/', '/create_magic_link', r'/verify_magic_link/.*'])\n\napp, rt = fast_app(live=True, debug=True, title=\"Gong Users\", favicon=\"favicon.ico\",\n                   before=bware, hdrs=(picolink,css),)\n\ndb_path = dbset.get_db_path()\ndb = database(db_path + 'gongUsers.db')\n\ndbset.create_tables(db)\ndbset.init_data(db)\n\nusers = db.t.users\nroles = db.t.roles\ncenters = db.t.centers\nplanners = db.t.planners\n\nRole = roles.dataclass()\nCenter = centers.dataclass()\nPlanner = planners.dataclass()\nUser = users.dataclass()\n\n@rt('/login')\ndef get():\n    return auth.login()\n\n@rt('/create_magic_link')\ndef post(email: str):\n    return auth.create_link(email, users)\n\n@rt('/verify_magic_link/{token}')\ndef get(session, token: str):\n    return auth.verify_link(session, token, users) \n\n# client = TestClient(app)\n\n@rt('/')\ndef home():\n    return Main(\n        Div(utils.display_markdown(\"home\")),\n        A(\"Login\",href=\"/login\", class_=\"button\"),\n        cls=\"container\"\n    )\n\n@rt('/dashboard')\ndef get(session): \n    sessemail = session['auth']\n    u = users[sessemail]\n    centers = planners(\"user_email = ?\", (u.email,))\n    center_names = \", \".join(c.center_name for c in centers)\n    return Main(\n        Nav(\n            Ul(\n                Li(A(\"Admin\", href=\"/admin_page\")) if u.role_name == \"admin\" else None ,\n                Li(A(href=\"/unfinished\")(\"Contact\")),\n                Li(A(\"About\", href=\"#\")),\n            ), \n            Button(\"Logout\", hx_post=\"/logout\"),\n        ),\n        Div(H1(\"Dashboard\"), P(f\"You are logged in as '{u.email}' with role '{u.role_name}' and access to gong planning for center(s) : {center_names}.\")),\n        cls=\"container\",\n    )\n\n@rt('/admin_page')\n@admin_required\ndef get(session, request):\n    return admin.show_page(request, db)\n\n@rt('/delete_user/{email}')\n@admin_required\ndef post(session, email: str):\n    return adchan.delete_user(email, db)\n\n@rt('/add_user')\n@admin_required\ndef post(session, new_user_email: str = \"\", name: str = \"\",role_name: str =\"\"):\n    return adchan.add_user(new_user_email, name ,role_name, db)\n\n@rt('/delete_center/{center_name}')\n@admin_required\ndef post(session, center_name: str):\n    return adchan.delete_center(center_name, db, db_path)\n\n@rt('/add_center')\n@admin_required\ndef post(session, new_center_name: str = \"\", new_center_location: str = \"\",new_gong_db_name: str = \"\", db_template: str = \"\"):\n    return adchan.add_center(new_center_name, new_center_location, new_gong_db_name, db_template, db, db_path)\n\n@rt('/delete_planner/{user_email}/{center_name}')\n@admin_required\ndef post(session, user_email: str, center_name: str):\n    return adchan.delete_planner(user_email, center_name, db)\n\n@rt('/add_planner')\n@admin_required\ndef post(session, new_planner_user_email: str = \"\", new_planner_center_name: str = \"\"):\n    return adchan.add_planner(new_planner_user_email, new_planner_center_name, db)\n\n@rt('/logout')\ndef post(session):\n    del session['auth']\n    return RedirectResponse('/login')\n\n@rt('/no_access_right')\ndef get():\n    return Main(\n        Nav(Li(A(\"Dashboard\", href=\"/dashboard\"))),\n        Div(H1(\"Access Denied\"),\n            P(\"You do not have permission to access this page.\")),\n        cls=\"container\"\n    )\n\n@rt('/unfinished')\ndef get():\n    return Main(\n        Nav(Li(A(\"Dashboard\", href=\"/dashboard\"))),\n        Div(H1(\"This feature is not yet implemented.\")),\n        cls=\"container\"\n    )\n\n@rt('/db_error')\ndef db_error(session, etext: str):\n    return Html(\n        Nav(Li(A(\"Dashboard\", href=\"/dashboard\"))),\n        Head(Title(\"Database error\")),\n        Body(Div(feedb.feedback_to_user({'error': 'db_error', 'etext': f'{etext}'}))),\n        (A(\"Dashboard\", href=\"/dashboard\")),\n        cls=\"container\"\n    )\n\nserve()\n</code></pre>"},{"location":"gong-web-app/admin-change/","title":"Admin change functions","text":"<p>Used by the admin page in admin-show.md: functions to add or delete a user / center / planner.</p> <p>All these functions are called with these htmx (intro) tags: - <code>hx_post=</code> route to the function - <code>hx_target=</code> id of DOM element where the resulting html will be placed and these functions can update multiple other DOM elements with <code>hx_swap_oob=\"true\"</code></p> file: libs/adchan.py<pre><code>import shutil\nfrom fasthtml.common import *\nfrom libs.feedb import *\nfrom libs.admin import *\nfrom libs.utils import isa_db_test\n\n&lt;&lt;delete-user&gt;&gt;\n&lt;&lt;add-user&gt;&gt;\n&lt;&lt;delete-center&gt;&gt;\n&lt;&lt;add-center&gt;&gt;\n&lt;&lt;delete-planner&gt;&gt;\n&lt;&lt;add-planner&gt;&gt;\n</code></pre> <p>#delete-user<pre><code># @rt('/delete_user/{email}')\n\ndef delete_user(email, db):\n    users = db.t.users\n    centers = db.t.centers\n    planners = db.t.planners\n    try:\n        user_info = users(\"email = ?\",(email,))\n        user_planners = planners(\"user_email = ?\", (email,))  ## [1]\n\n        if not user_info:\n            message = {'error' : 'user_not_found'}\n\n        elif user_planners:  ## [1] \n            center_names = [p.center_name for p in user_planners]  ## [2]\n            centers_list = \", \".join(center_names)\n            message = {\"error\": \"user_has_planners\", \"centers\": f\"{centers_list}\"}\n\n        else:  ## [3]\n            db.execute(\"DELETE FROM users WHERE email = ?\", (email,))\n            message = {\"success\": \"user_deleted\"}\n\n        if isa_db_test(db): return message\n        return Div(\n            Div(feedback_to_user(message)),\n            Div(show_users_table(users), hx_swap_oob=\"true\", id=\"users-table\") if \"success\" in message else None,\n            ## [4]\n            Div(show_planners_form(users, centers), hx_swap_oob=\"true\", id=\"planners-form\") if \"success\" in message else None\n        )\n    except Exception as e:\n        return Redirect(f'/db_error?etext={e}')\n</code></pre> [1] Check if user has any planner associations [2] Get the center names for the error message [3] Proceed with deletion [4] rebuild the dropdown of the planners form to show changed users/centers </p> <p>#add-user<pre><code># @rt('/add_user')\n\ndef add_user(new_user_email, name ,role_name, db):\n    users = db.t.users\n    roles = db.t.roles\n    centers = db.t.centers\n    try:\n        if new_user_email == \"\" or name == \"\" or role_name == \"\":\n            message = {\"error\" : \"missing_fields\"}\n\n        elif not roles(\"role_name = ?\", (role_name,)):\n            message = {\"error\": \"invalid_role\"}\n\n        elif users(\"email = ?\", (new_user_email,)):\n            message = {\"error\": \"user_exists\"}\n\n        else:  ## [1]\n            users.insert(\n            email=new_user_email,\n            name=name,\n            role_name=role_name,\n            is_active=False,\n            magic_link_token=None,\n            magic_link_expiry=None\n            )\n            message = {\"success\": \"user_added\"}\n\n        if isa_db_test(db): return message\n        return Div(\n            Div(feedback_to_user(message)),\n            Div(show_users_table(users), hx_swap_oob=\"true\", id=\"users-table\") if \"success\" in message else None,\n            Div(show_users_form(roles), hx_swap_oob=\"true\", id=\"users-form\"),\n            ## [2]\n            Div(show_planners_form(users, centers), hx_swap_oob=\"true\", id=\"planners-form\") if \"success\" in message else None\n        )\n    except Exception as e:\n        return Redirect(f'/db_error?etext={e}')\n</code></pre> [1] creates the new user [2] rebuild the dropdown of the planners form to show changed users/centers  </p> <p>#delete-center<pre><code># @rt('/delete_center/{center_name}')\n\ndef delete_center(center_name, db, db_path):\n    users = db.t.users\n    User = users.dataclass()\n    centers = db.t.centers\n    Center = centers.dataclass()\n    planners = db.t.planners\n    Planner = planners.dataclass()\n    try:\n        center_info = centers(\"center_name = ?\", (center_name,))\n        if not center_info:\n            message = {'error' : 'center_not_found'}\n        else:\n            gong_db_name = center_info[0].gong_db_name  ## [1]\n            db_file_path = f'{db_path}{gong_db_name}'  ## [1]\n            center_planners = planners(\"center_name = ?\", (center_name,))  ## [2]\n\n            if center_planners:  ## [2]\n                user_emails = [p.user_email for p in center_planners]  ## [3]\n                users_list = \", \".join(user_emails)\n                message = {'error' : 'center_has_planners','users' : f'{users_list}'}\n\n            else:  ## [4]\n                db.execute(\"DELETE FROM centers WHERE center_name = ?\", (center_name,))\n                if os.path.exists(db_file_path):\n                    os.remove(db_file_path)\n                message = {'success' : 'center_deleted'}\n\n        if isa_db_test(db): return message\n        return Div(\n            Div(feedback_to_user(message)),\n            Div(show_centers_table(centers), hx_swap_oob=\"true\", id=\"centers-table\") if \"success\" in message else None,\n            ## [6]\n            Div(show_planners_form(users, centers), hx_swap_oob=\"true\", id=\"planners-form\") if \"success\" in message else None\n        )\n    except Exception as e:\n        print(e)\n        return Redirect(f'/db_error?etext={e}')\n</code></pre> [1] get gong database path [2] check if center has planners [3] get planners emails for error message [4] delete the center and the associated database file if it exists [5] also remove any SQLite journal files [6] rebuild the dropdown of the planners form to show changed users/centers </p> <p>#add-center<pre><code># @rt('/add_center')\n\ndef add_center(new_center_name, new_center_location, new_gong_db_name, db_template, db, db_path):\n    users = db.t.users\n    centers = db.t.centers\n    ## [1]\n    if not new_gong_db_name.endswith('.db'):\n        new_gong_db_name += '.db'\n    db_file_path = f'{db_path}{new_gong_db_name}'\n    template_db = f'{db_path}{db_template}'\n\n    try:\n        if new_center_name == \"\" or new_gong_db_name == \"\" or new_center_location == \"\" or db_template == \"\":\n            message = {\"error\" : \"missing_fields\"}\n\n        elif centers(\"center_name = ?\", (new_center_name,)):\n            message = {\"error\" : \"center_exists\"}\n\n        elif os.path.exists(db_file_path):\n            message = {\"error\" : 'db_file_exists'}\n\n        elif not os.path.exists(template_db):\n            message = {'error' : 'template_not_found'}\n\n        else:  ## [2]\n            shutil.copy2(template_db, db_file_path)\n            centers.insert(\n                center_name=new_center_name,\n                gong_db_name=new_gong_db_name,\n                location=new_center_location,\n                other_course=\"{}\"\n            )\n            message = {'success': 'center_added'}\n\n        if isa_db_test(db): return message\n        return Div(\n            Div(feedback_to_user(message)),\n            Div(show_centers_table(centers), hx_swap_oob=\"true\", id=\"centers-table\") if \"success\" in message else None,\n            Div(show_centers_form(centers), hx_swap_oob=\"true\", id=\"centers-form\"),\n            ## [3]\n            Div(show_planners_form(users, centers), hx_swap_oob=\"true\", id=\"planners-form\") if \"success\" in message else None\n        )\n    except Exception as e:\n        return Redirect(f'/db_error?etext={e}')\n</code></pre> [1] Ensure gong_db_name ends with .db [2] Create the new database by copying mahi.db and update center table [3] rebuild the dropdown of the planners form to show changed users/center </p> <p>#delete-planner<pre><code># @rt('/delete_planner/{user_email}/{center_name}')\n\ndef delete_planner(user_email, center_name, db):\n    planners = db.t.planners\n    try:\n        center_planners = planners(\"center_name = ?\", (center_name,))\n        if len(center_planners) == 1:  ## [1]\n            message ={\"error\" : \"last_planner_for_center\", \"center\" : f\"{center_name}\"}\n\n        else:  ## [2]\n            db.execute(\"DELETE FROM planners WHERE user_email = ? AND center_name = ?\", (user_email, center_name))\n            message = {\"success\" : \"planner_deleted\"}\n\n        if isa_db_test(db): return message\n        return Div(\n            Div(feedback_to_user(message)),\n            Div(show_planners_table(planners), hx_swap_oob=\"true\", id=\"planners-table\") if \"success\" in message else None\n        )\n\n    except Exception as e:\n        return Redirect(f'/db_error?etext={e}')\n</code></pre> [1] if this is the only planner for this center, prevent deletion [2] proceed with deletion </p> <p>#add-planner<pre><code># @rt('/add_planner')\n\ndef add_planner(new_planner_user_email, new_planner_center_name, db):\n    users = db.t.users\n    centers = db.t.centers\n    planners = db.t.planners\n    try:\n        if new_planner_user_email == \"\" or new_planner_center_name == \"\":\n            message = {\"error\" : \"missing_fields\"}\n\n        elif not users(\"email = ?\", (new_planner_user_email,)):\n            message = {\"error\" : \"user_not_found\"}\n\n        elif not centers(\"center_name = ?\", (new_planner_center_name,)):\n            message = {'error' : 'center_not_found'}\n\n        elif planners(\"user_email = ? AND center_name = ?\", (new_planner_user_email, new_planner_center_name)):\n            message = {'error' : 'planner_exists'}\n\n        else:  ## [1]\n            planners.insert(\n            user_email=new_planner_user_email,\n            center_name=new_planner_center_name\n            )\n            message = {'success' : 'planner_added'}\n\n        if isa_db_test(db): return message\n        return Div(\n            Div(feedback_to_user(message)),\n            Div(show_planners_table(planners), hx_swap_oob=\"true\", id=\"planners-table\") if \"success\" in message else None,\n            Div(show_planners_form(users, centers), hx_swap_oob=\"true\", id=\"planners-form\")\n        )\n    except Exception as e:\n        return Redirect(f'/db_error?etext={e}')\n</code></pre> [1] add planner association </p>"},{"location":"gong-web-app/admin-show/","title":"Admin page","text":"<p>Will only be reachable for signed in admin users.</p> file: libs/admin.py<pre><code>from fasthtml.common import *\nfrom libs.feedb import *\nfrom libs.utils import *\n\n&lt;&lt;show-users&gt;&gt;\n&lt;&lt;show-centers&gt;&gt;\n&lt;&lt;show-planners&gt;&gt;\n&lt;&lt;admin-page&gt;&gt;\n</code></pre> <p>TODO document admin-show</p> #show-users<pre><code>def show_users_table(users):\n    return Main(\n        Table(\n            Thead(\n                Tr(Th(\"Email\"), Th(\"Name\"), Th(\"Role\"), Th(\"Active\"), Th(\"Action\"))\n            ),\n            Tbody(\n                *[Tr(\n                    Td(u.email), \n                    Td(u.name or \"\"), \n                    Td(u.role_name), \n                    Td(\"Yes\" if u.is_active else \"No\"),\n                    Td(A(\"Delete\", hx_post=f\"/delete_user/{u.email}\", hx_target=\"#users-feedback\", hx_confirm=\"Are you sure you want to delete this user?\"))\n                ) for u in sorted(users(), key=lambda x: x.name)]\n            )\n        )\n    )\n\n\ndef show_users_form(roles):\n    role_names = [r.role_name for r in roles()]\n    return Main(\n        Div(\n            Form(\n                Input(type=\"email\", placeholder=\"User Email\", name=\"new_user_email\", required=True),\n                Input(type=\"text\", placeholder=\"User full name\", name=\"name\", required=True),                \n                Select( \n                    Option(\"Select Role\", value=\"\", selected=True, disabled=True),\n                    *[Option(role, value=role) for role in role_names],\n                        name=\"role_name\", required=True),\n                Button(\"Add User\", type=\"submit\"), hx_post=\"/add_user\",hx_target=\"#users-feedback\"\n            )\n        )    \n    )\n</code></pre> #show-centers<pre><code>def show_centers_table(centers):\n    return Main(\n        Table(\n            Thead(\n                Tr(Th(\"Center Name\"), Th(\"Dhamma.org location\"), Th(\"Gong DB Name\"), Th(\"Actions\"))\n            ),\n            Tbody(\n                *[Tr(\n                    Td(c.center_name),\n                    Td(c.location),\n                    Td(c.gong_db_name), \n                    Td(A(\"Delete\", hx_post=f\"/delete_center/{c.center_name}\", hx_target=\"#centers-feedback\", hx_confirm=\"Are you sure you want to delete this center?\"))\n                ) for c in sorted(centers(), key=lambda x: x.center_name)]\n            )\n        )\n    )\n\ndef show_centers_form(centers):\n    center_dbs = sorted(c.gong_db_name for c in centers())\n    return Main(\n        Div(\n            Form(\n                Input(type=\"text\", placeholder=\"Center Name\", name=\"new_center_name\", required=True),\n                Input(type=\"text\", placeholder=\"Center location number (dhamma.org)\", name=\"new_center_location\", required=True),\n                Input(type=\"text\", placeholder=\"Gong DB Name (without .db)\", name=\"new_gong_db_name\", required=True),\n                Select(\n                    Option(\"Center planning to copy\", value=\"\", selected=True, disabled=True),\n                    *[Option(cdb, value=cdb) for cdb in center_dbs],\n                    name=\"db_template\", required=True\n                ),\n                Button(\"Add Center\", type=\"submit\"), hx_post=\"/add_center\",hx_target=\"#centers-feedback\"\n            )\n        )\n    )\n</code></pre> #show-planners<pre><code>def show_planners_table(planners):\n    return Main(\n        Table(\n            Thead(\n                Tr(Th(\"User Email\"), Th(\"Center Name\"), Th(\"Actions\"))\n            ),\n            Tbody(\n                *[Tr(\n                    Td(p.user_email), \n                    Td(p.center_name), \n                    Td(A(\"Delete\", hx_post=f\"/delete_planner/{p.user_email}/{p.center_name}\", hx_target=\"#planners-feedback\", hx_confirm='Are you sure you want to delete this planner association?'))\n                ) for p in sorted(planners(), key=lambda x: x.center_name)]\n            )\n        )\n    )\n\ndef show_planners_form(users, centers):\n    sorted_centers = sorted(centers(), key=lambda x: x.center_name)\n    sorted_users = sorted(users(), key=lambda x: x.name)\n    return Main(\n        Div(\n            Form(\n                Select(\n                    Option(\"Select User\", value=\"\", selected=True, disabled=True),\n                    *[Option(u.email, value=u.email) for u in sorted_users],\n                    name=\"new_planner_user_email\", required=True\n                ),\n                Select(\n                    Option(\"Select Center\", value=\"\", selected=True, disabled=True),\n                    *[Option(c.center_name, value=c.center_name) for c in sorted_centers],\n                    name=\"new_planner_center_name\", required=True\n                ),\n                Button(\"Add Planner\", type=\"submit\"), hx_post=\"/add_planner\", hx_target=\"#planners-feedback\"\n            )\n        )\n    )\n</code></pre> #admin-page<pre><code># @rt('/admin_page')\ndef show_page(request, db):\n    params = dict(request.query_params)\n    users = db.t.users\n    roles = db.t.roles\n    centers = db.t.centers\n    planners = db.t.planners\n    return Main(\n        Nav(\n            Ul(\n                Li(A(\"Dashboard\", href=\"/dashboard\")),\n                Li(A(\"Contact\", href=\"#\")),\n                Li(A(\"About\", href=\"#\")),\n            ), \n            Button(\"Logout\", hx_post=\"/logout\"),\n        ),\n        Div(display_markdown(\"admin-show\")),\n        feedback_to_user(params),\n\n        H2(\"Users\"),\n        Div(feedback_to_user(params), id=\"users-feedback\"),\n        Div(show_users_table(users), id=\"users-table\"),\n        H4(\"Add New User\"),\n        Div(show_users_form(roles), id=\"users-form\"),\n\n        H2(\"Centers\"),\n        Div(feedback_to_user(params), id=\"centers-feedback\"),\n        Div(show_centers_table(centers), id=\"centers-table\"),\n        H4(\"Add New Center\"),\n        Div(show_centers_form(centers), id=\"centers-form\"),\n\n        # show_planners(),\n        H2(\"Planners\"),\n        Div(feedback_to_user(params), id=\"planners-feedback\"),\n        Div(show_planners_table(planners), id=\"planners-table\"),\n        H4(\"Add New Planner\"),\n        Div(show_planners_form(users, centers), id=\"planners-form\"),\n\n        cls=\"container\",\n    )\n</code></pre>"},{"location":"gong-web-app/authenticate/","title":"Authentication","text":"<p>This is a passwordless authentication:</p> <ul> <li>The user enters their email on a website</li> <li>The website generates a random string (a \"token\") and saves it together with the user's email into a database</li> <li>The website sends an email to the user with a link that encodes the generated token</li> <li>The user clicks on the link</li> <li>The website looks for a record in the users database table with the token from the link</li> <li>If it can find a record, the user will be logged in (again by storing information in the session)</li> </ul> file: libs/auth.py<pre><code>import socket\nimport secrets\nfrom datetime import datetime, timedelta\nfrom functools import wraps\nfrom fasthtml.common import *\nfrom libs.feedb import feedback_to_user\nfrom libs.utils import isa_dev_computer, send_email\n\n&lt;&lt;build-serve-login-form&gt;&gt;\n&lt;&lt;handling-form&gt;&gt;\n&lt;&lt;send-link&gt;&gt;\n&lt;&lt;verify-link&gt;&gt;\n&lt;&lt;admin_required&gt;&gt;\n</code></pre>"},{"location":"gong-web-app/authenticate/#login-form","title":"Login form","text":"<p>The actual form element is extracted into a MyForm() function. Its not really needed this time, since we don't use it a second time!</p> #build-serve-login-form<pre><code>def signin_form():\n   return Form(\n       Div(\n           Div(\n               Input(id='email', type='email', placeholder='foo@bar.com'),\n           ),\n       ),\n       Button(\"Sign In with Email\", type=\"submit\", id=\"submit-btn\"),\n       hx_post=\"/create_magic_link\",\n       hx_target=\"#error\",\n       hx_disabled_elt=\"#submit-btn\"\n   )\n\n\"\"\"\n@rt('/login')\ndef get():   \n    return auth.login()\n\"\"\"    \ndef login():\n   return Main(\n       Div(\n           H1(\"Sign In\"),\n           P(\"Enter your email to sign in to The App.\"),\n           Div(signin_form(), id='login_form'),\n           P(id=\"error\")\n       ), cls=\"container\"\n   )\n</code></pre>"},{"location":"gong-web-app/authenticate/#handling-the-login-form","title":"Handling the login form","text":"<p>This handler first checks if the email is present. If its not, it returns an error that will be swapped into the #error paragraph in the form by HTMX, just like last time.</p> <p>We create a magic_link_token using the secrets package from the python standard library. This token is a 32 characters long string. Also we generate an expiry date, which lies 15 minutes in the future.</p> <p>The token should only be valid for a certain amount of time to increase the security of the authentication system.</p> <p>Then it tries to find a user with the given email and if there is no user with this email, the IndexError is raised and it returns an error like above.</p> <p>Another option would be to create a new user now by replacing:</p> <pre><code>return \"Email is not registered ...\"\n</code></pre> <p>with:</p> <pre><code>user = User(email=email, is_active=False, magic_link_token=magic_link_token, magic_link_expiry=magic_link_expiry)\nusers.insert(user)\n</code></pre> <p>Then we update the user row in the database with the expiration date and the token itself.</p> <p>Then we create the login link by adding the token to the base url. If we are from Railway production, os.name == 'posix' and the base URL is saved in the RAILWAY_PUBLIC_DOMAIN environment variable. If we are running locally (os.name == 'nt'), directly or within railway CLI, the base URL is http://localhost:5001.</p> <p>If everything went well, we return a success message to the user. Remember, the form has been defined to swap the content of the #error paragraph. Since I want to change the appearance of the text we send back, I also send back a HX-Reswap header with the value outerHTML. This tells HTMX to swap the outer HTML of the #error html element with the content we send back, a paragraph tag with the success message.</p> <p>Also I want to disable the submit button and show a message that the magic link has been sent. To do this, we use one of the most powerful features of HTMX, out-of-band swaps. In HTMX you can update more than one piece of UI by setting the hx-swap-oob attribute to true on an element. HTMX will then swap in the returned element at the location of the element with the same id (#submit-btn in this case). You can read more about HTMX's out-of-band swaps here.</p> #handling-form<pre><code>\"\"\"\n@rt('/create_magic_link')\ndef post(email: str):\n    return auth.create_link(email, users)\n\"\"\"\ndef create_link(email,users):\n    if not email:\n       return (feedback_to_user({'error': 'missing_email'}))\n\n    magic_link_token = secrets.token_urlsafe(32)\n    magic_link_expiry = datetime.now() + timedelta(minutes=15)\n    try:\n       user = users[email]\n       users.update(email= email, magic_link_token= magic_link_token, magic_link_expiry= magic_link_expiry)\n    except NotFoundError:\n        return Div(\n            (feedback_to_user({'error': 'not_registered', 'email': f\"{email}\"})),\n            Div(signin_form(), hx_swap_oob=\"true\", id=\"login_form\")\n        )\n\n    domainame = os.environ.get('RAILWAY_PUBLIC_DOMAIN', None)\n\n    if (not isa_dev_computer()) and (domainame is not None):\n        base_url = 'https://' + os.environ.get('RAILWAY_PUBLIC_DOMAIN')\n    else: \n        print(\" machine name: \" + socket.gethostname())\n        base_url = 'http://localhost:5001'\n\n    magic_link = f\"{base_url}/verify_magic_link/{magic_link_token}\"\n    send_magic_link_email(email, magic_link)\n\n    return P(feedback_to_user({'success': 'magic_link_sent'}), id=\"success\"),\n    HttpHeader('HX-Reswap', 'outerHTML'), Button(\"Magic link sent\", type=\"submit\", id=\"submit-btn\", disabled=True, hx_swap_oob=\"true\")\n</code></pre>"},{"location":"gong-web-app/authenticate/#send-the-magic-link","title":"Send the magic link","text":"<p>Now we only need to send an email to the user with the link. The link then sends a get request to the /verify_magic_link/{token} endpoint.</p> <p>In production mode - remote or local within railway CLI -, we can use the smtplib via send_email (in utilities.md) to send an email using Gmail's SMTP server. </p> <p>In dev mode, lets just mock sending the email by printing the email content to the console.</p> #send-link<pre><code>def send_magic_link_email(email_address: str, magic_link: str):\n\n   email_subject = \"Sign in to The App\"\n   email_text = f\"\"\"\n   Hey there,\n\n   Click this link to sign in to The App: {magic_link}\n\n   If you didn't request this, just ignore this email.\n\n   Cheers,\n   The App Team\n   \"\"\"\n   if isa_dev_computer():\n       print(f'To: {email_address}\\n Subject: {email_subject}\\n\\n{email_text}')\n   else:\n       send_email(email_subject, email_text, [email_address])\n</code></pre>"},{"location":"gong-web-app/authenticate/#authenticate-the-user","title":"Authenticate the user","text":"<p>We save the current time into the variable now, because we need to look whether the token is already expired. Then we retrieve the first item with the specified token and an expiration date that lies in the future from the users table.</p> <p>There should only be one or no user coming back from this query, so we wrap this whole code in a try/catch block.</p> <p>If a user has been found using this query, we will save his or hers email in the auth key of our session dictionary. If its the first time the user logs in, we set is_active to true for this database record.</p> <p>We do this to keep our database clean. Imagine a hacker enters thousands of random email addresses into our beautiful sign in form and therefore creates thousands of records in our database. To keep our database clean, we can use this is_active column to delete all inactive database records periodically using cron jobs.</p> #verify-link<pre><code>\"\"\"\n@rt('/verify_magic_link/{token}')\ndef get(session, token: str):\n    return auth.verify_link(session, token, users) \n\"\"\"\ndef verify_link(session, token, users):\n   nowstr = f\"'{datetime.now()}'\"\n   try:\n       user = users(\"magic_link_token = ? AND magic_link_expiry &gt; ?\", (token, nowstr))[0]\n       session['auth'] = user.email\n       session['role'] = user.role_name\n       users.update(email= user.email, magic_link_token= None, magic_link_expiry= None, is_active= True)\n       return RedirectResponse('/dashboard')\n   except IndexError:\n       return \"Invalid or expired magic link\"\n</code></pre> #admin_required<pre><code>def admin_required(handler):\n    @wraps(handler)\n    def wrapper(session, *args, **kwargs):\n        role = session['role']\n        if not role or not role == \"admin\":\n            # Redirect to unauthorized page if not admin\n            return RedirectResponse('/no_access_right')\n        # Proceed if user is admin\n        return handler(session, *args, **kwargs)\n    return wrapper\n</code></pre>"},{"location":"gong-web-app/database-setup/","title":"Database setup and init","text":"file: libs/dbset.py<pre><code>import textwrap\nimport os\nfrom fasthtml.common import database\nfrom libs.utils import isa_dev_computer\n\n&lt;&lt;getdb-path&gt;&gt;\n&lt;&lt;setup-database&gt;&gt;\n&lt;&lt;initialize-database&gt;&gt;\n</code></pre>"},{"location":"gong-web-app/database-setup/#database-path","title":"Database path","text":"#getdb-path<pre><code>def get_db_path():\n    root = \"\" if isa_dev_computer() else os.environ.get('RAILWAY_VOLUME_MOUNT_PATH',\"None\")\n    return root + \"data/\"\n</code></pre>"},{"location":"gong-web-app/database-setup/#database-setup","title":"Database setup","text":"#setup-database<pre><code>def create_tables(db):\n    SQL_CREATE_ROLES = \"\"\"\n    CREATE TABLE IF NOT EXISTS roles (\n        role_name TEXT PRIMARY KEY,\n        description TEXT\n    );\n    \"\"\"\n    SQL_CREATE_CENTERS = \"\"\"\n    CREATE TABLE IF NOT EXISTS centers (\n        center_name TEXT PRIMARY KEY,\n        gong_db_name TEXT,\n        location TEXT,\n        other_course TEXT\n    );\n    \"\"\"\n    SQL_CREATE_USERS = \"\"\"\n    CREATE TABLE IF NOT EXISTS users (\n        email TEXT PRIMARY KEY,\n        name TEXT,\n        role_name TEXT,\n        magic_link_token TEXT,\n        magic_link_expiry TIMESTAMP,\n        is_active BOOLEAN DEFAULT FALSE,\n        FOREIGN KEY (role_name) REFERENCES roles(role_name)\n    );\n\n    \"\"\"\n    SQL_CREATE_PLANNERS = \"\"\"\n    CREATE TABLE IF NOT EXISTS planners (\n        user_email TEXT,\n        center_name TEXT,\n        PRIMARY KEY (user_email, center_name),\n        FOREIGN KEY (user_email) REFERENCES users(email),\n        FOREIGN KEY (center_name) REFERENCES centers(center_name)\n    );\n    \"\"\"\n    db.execute(SQL_CREATE_ROLES)\n    db.execute(SQL_CREATE_CENTERS)\n    db.execute(SQL_CREATE_USERS)\n    db.execute(SQL_CREATE_PLANNERS)\n</code></pre>"},{"location":"gong-web-app/database-setup/#database-initialization","title":"Database initialization","text":"<p>Check if any table(s) is(are) empty and insert default values if needed</p> #initialize-database<pre><code>def init_data(db):\n\n    roles = db.t.roles\n    if not roles():\n        roles.insert(role_name=\"admin\", description=\"administrator\")\n        roles.insert(role_name=\"user\", description=\"regular user\")\n\n    centers = db.t.centers\n    other_course_pajjota = textwrap.dedent(\"\"\"\\\n            {\n            \"TRUST MEETING\": \"Trust WE\"\n            }\n        \"\"\").strip('\\n')\n    if not centers():\n        centers.insert(center_name=\"Mahi\", gong_db_name=\"mahi.db\", location = \"1396\", other_course = \"{ }\")\n        centers.insert(center_name=\"Pajjota\", gong_db_name=\"pajjota.db\", location = \"1370\", other_course=other_course_pajjota)\n\n    users = db.t.users\n    if not users():\n        users.insert(email=\"spegoff@authentica.eu\", name=\"sp1\", role_name=\"admin\", is_active=True, magic_link_token=None, magic_link_expiry=None)\n        users.insert(email=\"spegoff@gmail.com\", name=\"sp2\", role_name=\"user\", is_active=True)\n\n    planners = db.t.planners\n    if not planners():\n        planners.insert(user_email= \"spegoff@authentica.eu\", center_name= \"Mahi\")\n        planners.insert(user_email= \"spegoff@gmail.com\", center_name= \"Pajjota\")\n</code></pre>"},{"location":"gong-web-app/fetch-courses/","title":"Get schedule from dhamma.org and merge into center schedule","text":"file: libs/fetch.py<pre><code>import requests\nimport pandas as pd\nimport json\nfrom tabulate import tabulate\nfrom datetime import datetime, date, timedelta\nfrom fasthtml.common import *\n\nfrom libs.dbset import get_db_path\nfrom libs.utils import add_months_days\n\n# Example usage:\n# fetch_dhamma_courses(\"Mahi\", 6, 0)\n# fetch_dhamma_courses(\"Pajjota\", 6, 0)\n\ndef get_field_from_db(db_central, center_name, field_name):\n    # get the dhamma.org location for this center from the table settings in center db\n    centers = db_central.t.centers\n    Center = centers.dataclass()\n    if field_name == \"location\":\n        location = centers[center_name].location\n        return f\"location_{location}\"\n    else:\n        other_course = centers[center_name].other_course\n        return json.loads(other_course)\n\ndef fetch_courses_from_dhamma(location, date_start, date_end):\n    url = \"https://www.dhamma.org/en-US/courses/do_search\"\n    headers = {\"User-Agent\": \"entan-mkdocs-fetcher/1.0\"}\n    all_courses = []\n\n    # Initial page\n    page = 1\n\n    while True:\n        data = {\n            \"current_state\": \"OldStudents\",\n            \"regions[]\": location,\n            \"daterange\": f\"{date_start} - {date_end}\",\n            \"page\": str(page),\n        }\n\n        print(f\"Fetching courses Dhamma {location} - Page {page}...\")\n        try:\n            resp = requests.post(url, data=data, headers=headers, timeout=15)\n            resp.raise_for_status()\n            payload = resp.json()\n        except requests.RequestException as e:\n            print(\"Request error:\", e)\n            return []\n        except ValueError as e:\n            print(\"Invalid JSON:\", e)\n            return []\n\n        courses = payload.get(\"courses\", [])\n        all_courses.extend(courses)\n\n        # Check if there are more pages\n        total_pages = payload.get(\"pages\", 0)\n        if page &gt;= total_pages:\n            break\n\n        page += 1\n\n    # Extract relevant fields from all courses\n    extracted = [\n        {\n            \"course_start_date\": c.get(\"course_start_date\"),\n            \"course_end_date\": c.get(\"course_end_date\"),\n            \"raw_course_type\": c.get(\"raw_course_type\"),\n            \"course_type_anchor\": c.get(\"course_type_anchor\"),\n            \"course_type\": c.get(\"course_type\"),\n            \"sub_location\": c.get(\"location\", {}).get(\"sub_location\"),\n            \"center_non\": c.get(\"location\", {}).get(\"center_noncenter\"),\n        }\n        for c in all_courses\n    ]\n\n    # Filter out extracted where 'center_non' = 'noncenter'\n    extracted = [course for course in extracted if course['center_non'] != 'noncenter']\n\n    return extracted\n\ndef get_period_type(anchor, course_type, list_of_types, other_dict):\n    \"\"\"\n    If anchor == \"Other\", find in other_dict the value of a key == course_type\n    and return \"UNKNOWN\" if not found.\n    if anchor != \"Other\"' find the dict in list_of_types where 'raw_course_type' matches anchor and return the value of 'period_type'.\n    \"\"\"\n    if anchor == \"Other\":\n        return other_dict.get(course_type.upper(), \"UNKNOWN\")\n    else:    \n        for item in list_of_types:\n            if  anchor == item.get('raw_course_type'):\n                return item.get('period_type')\n    return \"UNKNOWN\"\n\ndef deduplicate(merged):\n    # Remove duplicates: if consecutive items have identical start_date and period_type,\n    # keep only one with source='BOTH'\n    deduplicated = []\n    i = 0\n    while i &lt; len(merged):\n        current = merged[i]\n        if i + 1 &lt; len(merged):\n            next_item = merged[i + 1]\n            if (current['start_date'] == next_item['start_date'] and \n                current['period_type'] == next_item['period_type']):\n                # Mark as BOTH and skip the next one\n                current['source'] = 'BOTH'\n                deduplicated.append(current)\n                i += 2  # skip next item\n                continue\n        deduplicated.append(current)\n        i += 1\n    return deduplicated\n\ndef fetch_dhamma_courses(center, num_months, num_days):\n\n    # get the path to the center db and the spreadsheet (see below)\n    db_path = get_db_path()\n\n    db_center = database(f\"{db_path}{center.lower()}.ok.db\")\n    db_central = database(f\"{db_path}gongUsers.db\")\n\n    # get the start date for the last course just before today = current course - or service\n    periods = db_center.t.coming_periods\n    Period = periods.dataclass()\n    count_past = sum(1 for item in periods() if date.fromisoformat(item.start_date) &lt; date.today())\n    date_current_course = periods()[count_past-1].start_date\n\n    # get a dict. of all courses in the center db starting from the current course\n    periods_db_center_obj = periods()[count_past-1:]\n    periods_db_center = [\n    {\n        'start_date': p.start_date,\n        'period_type': p.period_type,\n        'source' : f\"{center.lower()}_db\"\n\n    }\n    for p in periods_db_center_obj\n    ]\n\n    location = get_field_from_db(db_central, center, \"location\")\n    end_date = add_months_days(date_current_course, num_months, num_days)\n\n    # fetch extracted courses from dhamma.org\n    extracted = fetch_courses_from_dhamma(location, date_current_course, end_date)\n\n    # FIXME one day courses are possible in some centers !!!\n    extracted = [course for course in extracted if not course['raw_course_type'].startswith(\"1-Day\")]\n\n    # Remove the last two fields: 'sub_location' and 'center_non'\n    for course in extracted:\n        course.pop('sub_location', None)\n        course.pop('center_non', None)\n        # Remove \"OSC\" suffix from 'raw_course_type' and 'course_type_anchor' if present\n        # if course['raw_course_type'].endswith(\"OSC\"):\n        #      course['raw_course_type'] = course['raw_course_type'][:-3].strip()\n        if course['course_type_anchor'].endswith(\"OSC\"):\n            course['course_type_anchor'] = course['course_type_anchor'][:-3].strip()\n\n    # print(tabulate(extracted, headers=\"keys\", tablefmt=\"grid\"))\n\n    # get the course_type mapping table from the spreadsheet\n    # and use it to map the course types from dhamma.org to center db\n    df = pd.read_excel(db_path + 'course_type_map.xlsx')\n    list_of_types = df.to_dict(orient='records')\n    other_dict = get_field_from_db(db_central, center, \"other_dict\")\n    periods_dhamma_org = [\n        {\n            \"start_date\": c.get(\"course_start_date\"),\n            \"period_type\": get_period_type(c.get(\"course_type_anchor\"), c.get(\"course_type\"), list_of_types, other_dict),\n            \"source\": \"dhamma.org\",\n            \"course_type\": c.get(\"course_type\")\n        }\n        for c in extracted\n    ]\n\n    # print(tabulate(periods_dhamma_org, headers=\"keys\", tablefmt=\"grid\"))\n    # print(tabulate(periods_db_center, headers=\"keys\", tablefmt=\"grid\"))\n\n    merged = periods_db_center + periods_dhamma_org\n    merged.sort(key=lambda x: x['start_date'])\n    deduplicated = deduplicate(merged)\n\n    print(tabulate(deduplicated, headers=\"keys\", tablefmt=\"grid\"))\n    return\n</code></pre>"},{"location":"gong-web-app/user-feedback/","title":"User feedback","text":""},{"location":"gong-web-app/user-feedback/#successerror-messages","title":"Success/error messages","text":"file: libs/feedb.py<pre><code>from fasthtml.common import *\n\n&lt;&lt;feedback-to-user&gt;&gt;\n</code></pre> #feedback-to-user<pre><code>def feedback_to_user(params):\n    # query_params = dict(request.query_params)\n    # Handle success and error messages\n    success_messages = {\n        'magic_link_sent': \"A link to sign in has been sent to your email. Please check your inbox. The link will expire in 15 minutes.\",\n        'user_added': 'User added successfully!',\n        'center_added': 'Center added successfully!',\n        'planner_added': 'Planner association added successfully!',\n        'user_deleted': 'User deleted successfully!',\n        'center_deleted': 'Center and associated database deleted successfully!',\n        'planner_deleted': 'Planner association deleted successfully!'\n    }\n    error_messages = {\n        'missing_email':'Email is required.',\n        'not_registered':f'Email \"{params.get(\"email\", \"\")}\" is not registered, try again or send a message to xxx@xxx.xx to get registered',\n        'missing_fields': 'Please fill in all required fields.',\n        'user_exists': 'User with this email already exists.',\n        'center_exists': 'Center with this name already exists.',\n        'planner_exists': 'This planner association already exists.',\n        'user_not_found': 'User not found.',\n        'center_not_found': 'Center not found.',\n        'invalid_role': 'Invalid role selected.',\n        'db_error': f'Database error occurred: {params.get(\"etext\")}. Please contact the program support.',\n        'db_file_exists': 'Database file with this name already exists.',\n        'template_not_found': 'Template database (mahi.db) not found.',\n        'user_has_planners': f'Cannot delete user. User is still associated with centers: {params.get(\"centers\", \"\")}. Please remove all planner associations first.',\n        'center_has_planners': f'Cannot delete center. Center is still associated with users: {params.get(\"users\", \"\")}. Please remove all planner associations first.',\n        'last_planner_for_center': f'Cannot delete planner. This is the last planner for center \"{params.get(\"center\", \"\")}\". Each center must have at least one planner.'\n    }\n    message_div = None\n    if 'success' in params:\n        message = success_messages.get(params['success'], 'Operation completed successfully!')\n        message_div = Div(\n            Div(P(message), style=\"color: #d1f2d1; background: #0f5132; padding: 10px; border-radius: 5px; margin: 10px 0; border: 1px solid #198754; font-weight: 500;\"),\n            Small(\"To clear this message and/or update the tables, reload the page\")\n        )\n    elif 'error' in params:\n        message = error_messages.get(params['error'], 'An error occurred.')\n        message_div = Div(\n            Div(P(message), style=\"color: #f8d7da; background: #842029; padding: 10px; border-radius: 5px; margin: 10px 0; border: 1px solid #dc3545; font-weight: 500;\"),\n            Small(\"To clear this message, reload the page\")\n        )\n    return message_div\n</code></pre>"},{"location":"gong-web-app/utilities/","title":"Utilities","text":"<ul> <li>checking if the program runs on a development machine</li> <li>sending an email</li> <li>displaying the content of a markdown file</li> <li>route or function not implemented yet</li> </ul> file: libs/utils.py<pre><code>import socket\nimport calendar\nimport resend\nimport markdown2\nfrom datetime import datetime, date, timedelta\nfrom fasthtml.common import *\n\n&lt;&lt;dummy&gt;&gt;\n&lt;&lt;isdev-computer&gt;&gt;\n&lt;&lt;istest-db&gt;&gt;\n&lt;&lt;send-email&gt;&gt;\n&lt;&lt;display-markdown&gt;&gt;\n&lt;&lt;plus-months-days&gt;&gt;\n</code></pre>"},{"location":"gong-web-app/utilities/#dummy-start","title":"Dummy start","text":"#dummy<pre><code>def dummy():\n    return \"dummy\"\n</code></pre>"},{"location":"gong-web-app/utilities/#check-if-the-current-computer-is-a-development-machine","title":"Check if the current computer is a development machine","text":"<p>This function checks if the program runs on one of a predefined list of development machines. This is useful to determine whether to use a local or remote base URL for building the registation link.</p> #isdev-computer<pre><code>def isa_dev_computer():\n    DEV_COMPUTERS = [\"serge-asrock\",\"DESKTOP-UIPS8J2\",\"serge-virtual-linuxmint\",\"serge-framework\" ]\n    hostname = socket.gethostname()\n    return hostname in DEV_COMPUTERS\n</code></pre>"},{"location":"gong-web-app/utilities/#check-if-current-db-is-a-teporary-db-in-memory","title":"Check if current db is a teporary db in memory","text":"#istest-db<pre><code>def isa_db_test(db):\n    return 'Database &lt;apsw.Connection object \"\"' in str(db)\n</code></pre>"},{"location":"gong-web-app/utilities/#send-email","title":"Send email","text":""},{"location":"gong-web-app/utilities/#via-google-smtp","title":"via Google smtp","text":"<p>We will need to create an App Password in your Google Account settings as we have 2-Step Verification enabled. And we set up environmemt variables 'GOOGLE_SMTP_USER' and 'GOOGLE_SMTP_PASS' .</p>"},{"location":"gong-web-app/utilities/#via-resendcom","title":"via resend.com","text":"<p>As railway does not give smtp access to Hobby plan, we are using instead the resend API: https://resend.com/docs/send-with-python . And we set up the environmemt variable 'RESEND_API_KEY' .</p>"},{"location":"gong-web-app/utilities/#example","title":"Example","text":"<p>Using: send_email(subject, body, recipients)</p> <ul> <li>subject = \"Hello from Python\"</li> <li>body = \"This is a test email sent from Python.\"</li> <li>recipients = [\"recipient1@gmail.com\"]  : list of recipients </li> </ul> #send-email<pre><code>def send_email(subject, body, recipients):\n    # old code via smtp\n    \"\"\"\n    sender = os.environ.get('GOOGLE_SMTP_USER') \n    password = os.environ.get('GOOGLE_SMTP_PASS')\n    # Create MIMEText email object with the email body\n    msg = MIMEText(body)\n    msg['Subject'] = subject\n    msg['From'] = sender\n    msg['To'] = ', '.join(recipients)\n    # Connect securely to Gmail SMTP server and login\n    with smtplib.SMTP_SSL('smtp.gmail.com', 465) as smtp_server:\n        smtp_server.login(sender, password)\n        smtp_server.sendmail(sender, recipients, msg.as_string())\n    \"\"\"\n    # using resend\n    sender = \"spegoff@authentica.eu\" \n    resend.api_key = os.environ['RESEND_API_KEY']\n    params: resend.Emails.SendParams = {\n        \"from\": sender,\n        \"to\": recipients,\n        \"subject\": subject,\n        \"text\": body,\n    }\n    email = resend.Emails.send(params)\n    print(f'Message sent: {email}')\n</code></pre>"},{"location":"gong-web-app/utilities/#displaying-the-content-of-a-markdown-file","title":"Displaying the content of a markdown file","text":"<p>This function reads a markdown file name, without the extension '.md', then finds the file in the 'md-text' directory and converts it to HTML using the <code>markdown2</code> library, which is then returned as a NotStr object for rendering in the app.</p> #display-markdown<pre><code>def display_markdown(file_name:str):\n    with open(f'md-text/{file_name}.md', \"r\") as f:\n        html_content = markdown2.markdown(f.read())\n    return NotStr(html_content)\n</code></pre>"},{"location":"gong-web-app/utilities/#add-months-and-days-to-an-iso-date","title":"Add months and days to an ISO date","text":"<p>Return an ISO date string num_months and num_days after date_str (YYYY-MM-DD). Uses divmod to compute year/month rollover and preserves end-of-month.</p> #plus-months-days<pre><code>def add_months_days(date_str, num_months, num_days):\n    dt = datetime.strptime(date_str, \"%Y-%m-%d\").date()\n    # total months since year 0 (make month zero-based)\n    total = dt.year * 12 + (dt.month - 1) + num_months\n    new_year, new_month0 = divmod(total, 12)\n    new_month = new_month0 + 1\n    last_day = calendar.monthrange(new_year, new_month)[1]\n    new_day = min(dt.day, last_day)\n    result_date = date(new_year, new_month, new_day)\n    # Add num_days to the result\n    result_date += timedelta(days=num_days)\n    return result_date.isoformat()\n</code></pre>"},{"location":"obtain-schedule/API/","title":"dhamma.org courses API","text":""},{"location":"obtain-schedule/API/#request","title":"Request","text":"<ul> <li>POST request Request URL: https://www.dhamma.org/en-US/courses/do_search</li> <li>current_state=OldStudents&amp;regions[]=location_1370&amp;daterange=2025-11-02 - 2026-11-02&amp;page=1</li> <li>iterate over pages until reaching the \u2018pages\u2019 at the end of the Response</li> </ul>"},{"location":"obtain-schedule/API/#response","title":"Response","text":"<p>Summary with relevant fields</p> <pre><code>{\n    \"courses\": [\n    {\n        \"id\": 191183,\n        \"local_time\": \"2025-11-02T17:23:43.000+00:00\",\n        \"course_start_date\": \"2026-02-25\",\n        \"course_end_date\": \"2026-03-08\",\n        \"enrollment_open_date\": \"2025-11-25\",\n        \"localized_start_date\": \"Feb 25 2026\",\n        \"localized_end_date\": \"Mar 08 2026\",\n        \"raw_course_type\": \"10-Day\",\n        \"course_type_number_nights\": 11,\n        \"course_type_anchor\": \"10-Day\",\n        \"course_type\": \"10 days\",\n        \"location\": {\n        \"id\": 1370,\n        \"sub_domain\": \"pajjota\",\n        \"dhamma_name\": \"Dhamma Pajjota\",\n        ...\n        \"sub_location\": empty, # for Pajjota, else \"Brussels\" or \"Ghent\"\n        \"center_noncenter\": \"center\", # \"noncenter\" if not Pajjota\n        }\n    }\n    {other courses...}\n    ],\n    \"page\": 3,\n    \"pages\": 7,\n    \"total_rows\": 63,\n    \"formatted_total_rows\": \"63\",\n    \"pages_truncated\": false,\n    \"saved_search_uuid\": \"68f422a6-66cb-4a73-bc51-d4d43ef0a256\",\n    \"saved_search_params\": {\n    \"current_state\": \"OldStudents\",\n    \"regions\": [\n        \"location_1370\"\n    ]\n    }\n}\n</code></pre>"},{"location":"setup-deploy/a-python-environ/","title":"The python environment","text":"<p>Make sure this computer will be recognized by name as a dev machine : see isa_dev_computer() in utilities.md !!!</p> <p>To set up and manage the virtual Python environment for this project, we use the uv tool.</p> <p>VSCode extensions:</p> <ul> <li>Python (from Microsoft)</li> </ul>"},{"location":"setup-deploy/a-python-environ/#windows","title":"Windows","text":""},{"location":"setup-deploy/a-python-environ/#initial-installation","title":"Initial installation","text":"file: setup/environ.ps1<pre><code>scoop install main/uv\nuv python install\nuv venv\nuv pip install -r requirements.txt\n</code></pre>"},{"location":"setup-deploy/a-python-environ/#vscode-startup","title":"VSCode startup","text":"file: setup/startup.ps1<pre><code>.venv\\Scripts\\activate.ps1\n</code></pre>"},{"location":"setup-deploy/a-python-environ/#linux-mint","title":"Linux Mint","text":""},{"location":"setup-deploy/a-python-environ/#initial-installation_1","title":"Initial installation","text":"file: setup/environ.sh<pre><code>curl -LsSf https://astral.sh/uv/install.sh | sh\nuv python install\nuv venv\nuv pip install -r requirements.txt\n</code></pre>"},{"location":"setup-deploy/a-python-environ/#vscode-startup_1","title":"VSCode startup","text":"<pre><code>source .venv/bin/activate\n</code></pre>"},{"location":"setup-deploy/a-python-environ/#command","title":"command","text":"<p>python main.py</p>"},{"location":"setup-deploy/entangled/","title":"Entangled","text":"<p>Entangled is a tool to manage code snippets in Markdown files. It allows you to tangle code from Markdown files into separate source files and stitch changes back into the Markdown files. For full documentation visit:</p> <ul> <li>user documentation</li> <li>installation / configuration.</li> </ul> <p>Pandoc needs to be installed for Entangled.</p> <p>VSCode extensions:</p> <ul> <li>Markdown All in One</li> <li>Markdown Preview Enhanced</li> <li>Entangled VSCode : helps for editing the entangled files.</li> </ul>"},{"location":"setup-deploy/entangled/#initial-installation","title":"Initial Installation","text":""},{"location":"setup-deploy/entangled/#windows","title":"Windows","text":"file: setup/entangled.ps1<pre><code>scoop install pandoc\nuv pip install entangled-cli\n</code></pre>"},{"location":"setup-deploy/entangled/#linux-mint","title":"Linux Mint","text":"file: setup/entangled.sh<pre><code>sudo apt install pandoc\nuv pip install entangled-cli\n</code></pre>"},{"location":"setup-deploy/entangled/#commands","title":"Commands","text":"<p>see: entangled --help usage: entangled [-h] [-d] [-v] {tangle,stitch,sync,watch,status} ... </p> <p>positional arguments: {tangle,stitch,sync,watch,status}</p> <p>tangle Tangle codes from Markdown [-h] help, [-s] only show, [--force] force tangle [-r] rebuild file data base </p> <p>stitch Stitch code changes back into the Markdown [-h] help, [--force] force stitch, [-s] only show </p> <p>sync : Be smart wether to tangle or stich</p> <p>watch : Keep a loop running, watching for changes, then 'sync'  ! does not work on windows ! replaced by 'winwatch.ps1': - watches changes on markdown file in \\doc + main.py - triggers a 'entangled sync' on these files change - documented inside the file  </p> <p>status : show status of watched / updated files</p> <p>options : <pre><code>-h, --help            show this help message and exit  \n-d, --debug           enable debug messages  \n-v, --version         show version number  \n</code></pre></p>"},{"location":"setup-deploy/entangled/#entangled-conflicts-after-merging-branches","title":"Entangled conflicts after merging branches","text":"<p>Entangled can get confused when you merge, and there is a conflict on .entangled/filedb.json. This file keeps track of which files are sources for Entangled and which ones are generated by Entangled. That way, Entangled will never overwrite files it isn't supposed to, and the other way around, when you rename a target, the old one gets removed. It is very hard to merge this file though. When you need to, you can regenerate this file using:</p> <p>entangled tangle -r</p>"},{"location":"setup-deploy/entangled/#restoring-files-when-both-markdown-and-code-have-changed","title":"Restoring files when both Markdown and code have changed","text":"<p>When you edited both Markdown and code without the daemon running, you may need to do some tricks to get back into a consistent state.</p> <pre><code>git add . \ngit commit -m 'fixed everything'  # save everything you did\nentangled tangle --force          # overwrites some changes you made\ngit restore main.py               # retrieve from latest commit\nentangled stitch                  # apply changes back to markdown\ngit add .\ngit commit --amend                # amend your commit to perfection\n</code></pre>"},{"location":"setup-deploy/entangled/#configuration","title":"Configuration","text":"file: entangled.toml<pre><code>version = \"2.0\"\nwatch_list = [\"docs/**/*.md\"]\nhooks = [\"build\"]\n\n#[markers]\n#open=\"^(?P&lt;indent&gt;\\\\s*)```(?P&lt;properties&gt;.*)$\"\n#close=\"^(?P&lt;indent&gt;\\\\s*)```\\\\s*$\"\n\n[[languages]]\nname = \"Powershell\"\nidentifiers =  [\"powershell\", \"pwsh\"]\ncomment = { open = \"#\" }\n\n[[languages]]\nname = \"XML\"\nidentifiers = [\"xml\", \"html\", \"svg\"]\ncomment = { open = \"&lt;!--\", close = \"--&gt;\" }\n\n[[languages]]\nname = \"mermaid\"\nidentifiers =  [\"mermaid\"]\ncomment = { open = \"%%\" }\n\n[[languages]]\nname = \"yaml\"\nidentifiers =  [\"yaml\"]\ncomment = { open = \"#\" }\n\n[[languages]]\nname = \"toml\"\nidentifiers =  [\"toml\"]\ncomment = { open = \"#\" }\n</code></pre>"},{"location":"setup-deploy/mkdocs/","title":"MkDocs","text":"<p>MkDocs is a static site generator that's geared towards project documentation. It takes Markdown files and builds them into a static website. For full documentation visit mkdocs.org.</p>"},{"location":"setup-deploy/mkdocs/#initial-installation","title":"Initial Installation","text":""},{"location":"setup-deploy/mkdocs/#windows","title":"Windows","text":"file: setup/mkdocs.ps1<pre><code>uv pip install mkdocs\nuv pip install mkdocs-mermaid2-plugin\nuv pip install mkdocs-material\nuv pip install mkdocs-entangled-plugin\n</code></pre>"},{"location":"setup-deploy/mkdocs/#linux-mint","title":"Linux Mint","text":"file: setup/mkdocs.sh<pre><code>uv pip install mkdocs\nuv pip install mkdocs-mermaid2-plugin\nuv pip install mkdocs-material\nuv pip install mkdocs-entangled-plugin\n</code></pre>"},{"location":"setup-deploy/mkdocs/#commands","title":"Commands","text":"<ul> <li><code>mkdocs new [dir-name]</code> - Create a new project.</li> <li><code>mkdocs serve</code> - Start the live-reloading docs server at http://127.0.0.1:8000/</li> <li><code>mkdocs build</code> - Build the documentation site.</li> <li><code>mkdocs gh-deploy</code> - Deploy site on the gh-pages branch: see site_url in config. </li> <li><code>mkdocs -h</code> - Print help message and exit.</li> </ul>"},{"location":"setup-deploy/mkdocs/#configuration","title":"Configuration","text":"file: mkdocs.yml<pre><code>site_name: Gong system and apps for Vipassane centers\nsite_url: https://s66erge.github.io/entan-mkdocs\nrepo_url: https://github.com/s66erge/entan-mkdocs\n\nplugins:\n  - search\n  - entangled\n  - mermaid2:\n      arguments:\n         securityLevel: 'loose' \n\n#extra_javascript:\n#    - https://unpkg.com/mermaid/dist/mermaid.min.js\n\nmarkdown_extensions:\n  - toc:\n      permalink: \"#\"\n  - pymdownx.superfences:\n      custom_fences:\n        - name: mermaid\n          class: mermaid\n          format: !!python/name:pymdownx.superfences.fence_code_format\n#         format: !!python/name:mermaid2.fence_mermaid\n\ntheme:\n  name: readthedocs\n  name: material\n  features:\n    - content.code.copy\n  palette: \n    # Palette toggle for light mode\n    #- scheme: default\n    #  toggle:\n    #    icon: material/brightness-7 \n    #    name: Switch to dark mode\n\n    # Palette toggle for dark mode\n    - scheme: slate\n      toggle:\n        icon: material/brightness-4\n        name: Switch to light mode\n\n  watch:\n  - docs\n</code></pre> <p>Note: to use the 'material' theme, add '' under 'readthedocs'</p>"},{"location":"setup-deploy/mkdocs/#project-layout","title":"Project layout","text":"<pre><code>mkdocs.yml    # The configuration file.\ndocs/\n    index.md  # The documentation homepage.\n    ...       # Other markdown pages, images and other files.\n</code></pre>"},{"location":"setup-deploy/railway/","title":"Railway","text":"<p>Railway is a platform that allows you to deploy applications easily. It provides a simple way to host your applications and manage their deployments.</p>"},{"location":"setup-deploy/railway/#new-instruction-for-this-repo","title":"New instruction for this repo","text":"<p>Railway connected to Github : all changes pushed to Github repo branch 'master' are deployed immediately (+/-) to Railway 'entan-mkdocs', where the 'main.py' file is the entry point.</p>"},{"location":"setup-deploy/railway/#railway-cli","title":"Railway CLI","text":""},{"location":"setup-deploy/railway/#installation","title":"Installation","text":"<pre><code>scoop install railway\n</code></pre>"},{"location":"setup-deploy/railway/#using-it","title":"Using it","text":"<p>The Railway CLI is used to:</p> <ol> <li>link the local project to a Railway project:    <pre><code>railway link\n</code></pre></li> <li>run the app localy with the Railway project environment variables:    <pre><code>railway run python main.py\n</code></pre></li> </ol>"},{"location":"setup-deploy/railway/#resend-api-key","title":"Resend api key","text":"<p>On the entan-mkdocs service in Railway, define the variable 'RESEND_API_KEY'</p>"},{"location":"setup-deploy/railway/#previous-instructions","title":"Previous instructions","text":""},{"location":"setup-deploy/railway/#setup","title":"Setup","text":"<p>Run the commands below on your local machine. <pre><code>git clone https://github.com/AnswerDotAI/fh-deploy.git\ncd railway\npip install -r requirements.txt\n</code></pre></p>"},{"location":"setup-deploy/railway/#run-the-app-locally","title":"Run the app locally","text":"<pre><code>python main.py\n</code></pre>"},{"location":"setup-deploy/railway/#deploying-to-railway","title":"Deploying to Railway","text":"<ul> <li>create a Railway account and signup to the Hobby plan. </li> <li>install the Railway CLI.</li> <li>run <code>railway login</code> to log in to your Railway account.</li> <li>run <code>fh_railway_deploy YOUR_APP_NAME</code>.</li> </ul> <p>Your app's entry point must be located in a <code>main.py</code> file for this to work.</p>"},{"location":"setup-deploy/railway/#supplementary-info","title":"Supplementary Info.","text":""},{"location":"setup-deploy/railway/#whats-in-fh_railway_deploy","title":"what's in <code>fh_railway_deploy</code>","text":"<p><code>fh_railway_deploy</code> runs the following commands behind the scenes for you:</p> <pre><code>railway init -n &lt;app-name&gt;\nrailway up -c\nrailway domain\nrailway link ...\nrailway volume add -m /app/data\n</code></pre> <p>It handles automatically linking your current app to a railway project, setting up all the environment variables such as the port to listen on and setting up a <code>requirements.txt</code> if you haven't one already.</p>"},{"location":"setup-deploy/railway/#changing-the-start-command-or-sleep-directive-or","title":"Changing the start command or sleep directive or ...","text":"<p>Put a <code>railway.toml</code> file in the top application folder :</p> <pre><code>[build]\nbuilder = \"NIXPACKS\"\n\n[deploy]\nnumReplicas = 1\nsleepApplication = true\nstartCommand = \"uvicorn main:app --host 0.0.0.0 --port $PORT\"\n</code></pre>"},{"location":"setup-deploy/railway/#customizing-your-domain-name","title":"Customizing your Domain Name","text":"<p>Railway automatically assigns your website a unique domain name such as <code>quickdraw-production.up.railway.app</code>. However, if you want to use your own that you've purchased through services like GoDaddy or Squarespace Domains and have users be able to navigate to your site using that domain, you'll need to configure it both in your domain registration service and in Railway. Railway has put together a nice tutorial for setting it up here.</p> <p>Make sure to notice the difference between setting up a regular domain and a subdomain. Regular domains don't have any prefixes before the main site name such as <code>example.com</code> and is setup differently from a subdomain which might look like <code>subdomain.example.com</code>. Make sure to follow your domain registration service's documentation on how to set these types up.</p>"}]}