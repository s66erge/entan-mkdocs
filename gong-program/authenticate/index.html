
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://s66erge.github.io/entan-mkdocs/gong-program/authenticate/">
      
      
        <link rel="prev" href="../admin-show/">
      
      
        <link rel="next" href="../dashboard/">
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.14">
    
    
      
        <title>Authentication - My Docs</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.342714a4.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#authentication" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="My Docs" class="md-header__button md-logo" aria-label="My Docs" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            My Docs
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Authentication
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/s66erge/entan-mkdocs" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="My Docs" class="md-nav__button md-logo" aria-label="My Docs" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    My Docs
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/s66erge/entan-mkdocs" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" checked>
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Gong program
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Gong program
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../aaGongprog/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Main gong program
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../admin-change/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    User pages
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../admin-show/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    User pages
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    Authentication
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    Authentication
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#login-form" class="md-nav__link">
    <span class="md-ellipsis">
      Login form
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#handling-the-login-form" class="md-nav__link">
    <span class="md-ellipsis">
      Handling the login form
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#send-the-magic-link" class="md-nav__link">
    <span class="md-ellipsis">
      Send the magic link
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#authenticate-the-user" class="md-nav__link">
    <span class="md-ellipsis">
      Authenticate the user
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#beforeware-to-restrict-access" class="md-nav__link">
    <span class="md-ellipsis">
      Beforeware to restrict access
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../dashboard/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    User pages
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../data-def-db/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Data definitions and databases
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../utilities/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Utilities
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Setup deploy
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Setup deploy
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../setup-deploy/a-python-environ/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    The python environment
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../setup-deploy/entangled/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Entangled
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../setup-deploy/mkdocs/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    MkDocs
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../setup-deploy/railway/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Railway
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#login-form" class="md-nav__link">
    <span class="md-ellipsis">
      Login form
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#handling-the-login-form" class="md-nav__link">
    <span class="md-ellipsis">
      Handling the login form
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#send-the-magic-link" class="md-nav__link">
    <span class="md-ellipsis">
      Send the magic link
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#authenticate-the-user" class="md-nav__link">
    <span class="md-ellipsis">
      Authenticate the user
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#beforeware-to-restrict-access" class="md-nav__link">
    <span class="md-ellipsis">
      Beforeware to restrict access
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="authentication">Authentication</h1>
<p>This is a passwordless authentication:</p>
<ul>
<li>The user enters their email on a website</li>
<li>The website generates a random string (a "token") and saves it together with the user's email into a database</li>
<li>The website sends an email to the user with a link that encodes the generated token</li>
<li>The user clicks on the link</li>
<li>The website looks for a record in the users database table with the token from the link</li>
<li>If it can find a record, the user will be logged in (again by storing information in the session)</li>
</ul>
<div id="authenticate-md" class="highlight"><span class="filename">#authenticate-md</span><pre><span></span><code><span class="o">&lt;&lt;</span><span class="n">build</span><span class="o">-</span><span class="n">serve</span><span class="o">-</span><span class="n">login</span><span class="o">-</span><span class="n">form</span><span class="o">&gt;&gt;</span>
<span class="o">&lt;&lt;</span><span class="n">handling</span><span class="o">-</span><span class="n">form</span><span class="o">&gt;&gt;</span>
<span class="o">&lt;&lt;</span><span class="n">send</span><span class="o">-</span><span class="n">link</span><span class="o">&gt;&gt;</span>
<span class="o">&lt;&lt;</span><span class="n">verify</span><span class="o">-</span><span class="n">token</span><span class="o">&gt;&gt;</span>
<span class="o">&lt;&lt;</span><span class="n">logout</span><span class="o">&gt;&gt;</span>
</code></pre></div>
<h3 id="login-form">Login form</h3>
<p>The actual form element is extracted into a MyForm() function. Its not really needed this time, since we don't use it a second time!</p>
<div id="build-serve-login-form" class="highlight"><span class="filename">#build-serve-login-form</span><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">MyForm</span><span class="p">(</span><span class="n">btn_text</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">target</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
   <span class="k">return</span> <span class="n">Form</span><span class="p">(</span>
       <span class="n">Div</span><span class="p">(</span>
           <span class="n">Div</span><span class="p">(</span>
               <span class="n">Input</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="s1">&#39;email&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;email&#39;</span><span class="p">,</span> <span class="n">placeholder</span><span class="o">=</span><span class="s1">&#39;foo@bar.com&#39;</span><span class="p">),</span>
           <span class="p">),</span>
       <span class="p">),</span>
       <span class="n">Button</span><span class="p">(</span><span class="n">btn_text</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;submit&quot;</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="s2">&quot;submit-btn&quot;</span><span class="p">),</span>
       <span class="n">P</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="s2">&quot;error&quot;</span><span class="p">),</span>
       <span class="n">hx_post</span><span class="o">=</span><span class="n">target</span><span class="p">,</span>
       <span class="n">hx_target</span><span class="o">=</span><span class="s2">&quot;#error&quot;</span><span class="p">,</span>
       <span class="n">hx_disabled_elt</span><span class="o">=</span><span class="s2">&quot;#submit-btn&quot;</span>
   <span class="p">)</span>

<span class="nd">@rt</span><span class="p">(</span><span class="s1">&#39;/login&#39;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">get</span><span class="p">():</span>   
   <span class="k">return</span> <span class="n">Main</span><span class="p">(</span>
       <span class="n">Div</span><span class="p">(</span>
           <span class="n">H1</span><span class="p">(</span><span class="s2">&quot;Sign In&quot;</span><span class="p">),</span>
           <span class="n">P</span><span class="p">(</span><span class="s2">&quot;Enter your email to sign in to The App.&quot;</span><span class="p">),</span>
           <span class="n">MyForm</span><span class="p">(</span><span class="s2">&quot;Sign In with Email&quot;</span><span class="p">,</span> <span class="s2">&quot;/create_magic_link&quot;</span><span class="p">)</span>
       <span class="p">),</span> <span class="bp">cls</span><span class="o">=</span><span class="s2">&quot;container&quot;</span>
   <span class="p">)</span>
</code></pre></div>
<h3 id="handling-the-login-form">Handling the login form</h3>
<p>This handler first checks if the email is present. If its not, it returns an error that will be swapped into the #error paragraph in the form by HTMX, just like last time.</p>
<p>We create a magic_link_token using the secrets package from the python standard library. This token is a 32 characters long string. Also we generate an expiry date, which lies 15 minutes in the future.</p>
<p>The token should only be valid for a certain amount of time to increase the security of the authentication system.</p>
<p>Then it tries to find a user with the given email and if there is no user with this email, the IndexError is raised and it returns an error like above.</p>
<p>Another option would be to create a new user now by replacing:</p>
<div class="highlight"><pre><span></span><code>return &quot;Email is not registered ...&quot;
</code></pre></div>
<p>with:</p>
<div class="highlight"><pre><span></span><code>user = User(email=email, is_active=False, magic_link_token=magic_link_token, magic_link_expiry=magic_link_expiry)
users.insert(user)
</code></pre></div>
<p>Then we update the user row in the database with the expiration date and the token itself.</p>
<p>Then we create the login link by adding the token to the base url.
If we are from Railway production, os.name == 'posix' and the base URL is saved in the RAILWAY_PUBLIC_DOMAIN environment variable.
If we are running locally (os.name == 'nt'), directly or within railway CLI, the base URL is http://localhost:5001.</p>
<p>If everything went well, we return a success message to the user. Remember, the form has been defined to swap the content of the #error paragraph. Since I want to change the appearance of the text we send back, I also send back a HX-Reswap header with the value outerHTML. This tells HTMX to swap the outer HTML of the #error html element with the content we send back, a paragraph tag with the success message.</p>
<p>Also I want to disable the submit button and show a message that the magic link has been sent. To do this, we use one of the most powerful features of HTMX, out-of-band swaps. In HTMX you can update more than one piece of UI by setting the hx-swap-oob attribute to true on an element. HTMX will then swap in the returned element at the location of the element with the same id (#submit-btn in this case). You can read more about HTMX's out-of-band swaps <a href="https://htmx.org/docs/#oob_swaps">here</a>.</p>
<div id="handling-form" class="highlight"><span class="filename">#handling-form</span><pre><span></span><code><span class="nd">@rt</span><span class="p">(</span><span class="s1">&#39;/create_magic_link&#39;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">post</span><span class="p">(</span><span class="n">email</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">email</span><span class="p">:</span>
       <span class="k">return</span> <span class="s2">&quot;Email is required&quot;</span>

    <span class="n">magic_link_token</span> <span class="o">=</span> <span class="n">secrets</span><span class="o">.</span><span class="n">token_urlsafe</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span>
    <span class="n">magic_link_expiry</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
       <span class="n">user</span> <span class="o">=</span> <span class="n">users</span><span class="p">[</span><span class="n">email</span><span class="p">]</span>
       <span class="n">users</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">email</span><span class="o">=</span> <span class="n">email</span><span class="p">,</span> <span class="n">magic_link_token</span><span class="o">=</span> <span class="n">magic_link_token</span><span class="p">,</span> <span class="n">magic_link_expiry</span><span class="o">=</span> <span class="n">magic_link_expiry</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">NotFoundError</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;Email is not registered, try again or send a message to xxx@xxx.xx to get registered&quot;</span>

    <span class="n">domainame</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;RAILWAY_PUBLIC_DOMAIN&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">isa_dev_computer</span><span class="p">())</span> <span class="ow">and</span> <span class="p">(</span><span class="n">domainame</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
        <span class="n">base_url</span> <span class="o">=</span> <span class="s1">&#39;https://&#39;</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;RAILWAY_PUBLIC_DOMAIN&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span> 
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; machine name: &quot;</span> <span class="o">+</span> <span class="n">socket</span><span class="o">.</span><span class="n">gethostname</span><span class="p">())</span>
        <span class="n">base_url</span> <span class="o">=</span> <span class="s1">&#39;http://localhost:5001&#39;</span>

    <span class="n">magic_link</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">base_url</span><span class="si">}</span><span class="s2">/verify_magic_link/</span><span class="si">{</span><span class="n">magic_link_token</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">send_magic_link_email</span><span class="p">(</span><span class="n">email</span><span class="p">,</span> <span class="n">magic_link</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">P</span><span class="p">(</span><span class="s2">&quot;A link to sign in has been sent to your email. Please check your inbox. The link will expire in 15 minutes.&quot;</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="s2">&quot;success&quot;</span><span class="p">),</span> <span class="n">HttpHeader</span><span class="p">(</span><span class="s1">&#39;HX-Reswap&#39;</span><span class="p">,</span> <span class="s1">&#39;outerHTML&#39;</span><span class="p">),</span> <span class="n">Button</span><span class="p">(</span><span class="s2">&quot;Magic link sent&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;submit&quot;</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="s2">&quot;submit-btn&quot;</span><span class="p">,</span> <span class="n">disabled</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">hx_swap_oob</span><span class="o">=</span><span class="s2">&quot;true&quot;</span><span class="p">)</span>
</code></pre></div>
<h3 id="send-the-magic-link">Send the magic link</h3>
<p>Now we only need to send an email to the user with the link.
The link then sends a get request to the /verify_magic_link/{token} endpoint.</p>
<p>In production mode - remote or local within railway CLI -, we can use the smtplib via send_email (in utilities.md) to send an email using Gmail's SMTP server. </p>
<p>In dev mode, lets just mock sending the email by printing the email content to the console.</p>
<div id="send-link" class="highlight"><span class="filename">#send-link</span><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">send_magic_link_email</span><span class="p">(</span><span class="n">email_address</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">magic_link</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>

   <span class="n">email_subject</span> <span class="o">=</span> <span class="s2">&quot;Sign in to The App&quot;</span>
   <span class="n">email_text</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">   Hey there,</span>

<span class="s2">   Click this link to sign in to The App: </span><span class="si">{</span><span class="n">magic_link</span><span class="si">}</span>

<span class="s2">   If you didn&#39;t request this, just ignore this email.</span>

<span class="s2">   Cheers,</span>
<span class="s2">   The App Team</span>
<span class="s2">   &quot;&quot;&quot;</span>
   <span class="n">email_sender</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;GOOGLE_SMTP_USER&#39;</span><span class="p">,</span><span class="s1">&#39;None&#39;</span><span class="p">)</span>
   <span class="k">if</span> <span class="n">email_sender</span> <span class="o">==</span> <span class="s1">&#39;None&#39;</span><span class="p">:</span>
       <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;To: </span><span class="si">{</span><span class="n">email_address</span><span class="si">}</span><span class="se">\n</span><span class="s1"> Subject: </span><span class="si">{</span><span class="n">email_subject</span><span class="si">}</span><span class="se">\n\n</span><span class="si">{</span><span class="n">email_text</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
   <span class="k">else</span><span class="p">:</span>
       <span class="n">send_email</span><span class="p">(</span><span class="n">email_subject</span><span class="p">,</span> <span class="n">email_text</span><span class="p">,</span> <span class="p">[</span><span class="n">email_address</span><span class="p">])</span>
</code></pre></div>
<h3 id="authenticate-the-user">Authenticate the user</h3>
<p>We save the current time into the variable now, because we need to look whether the token is already expired. Then we retrieve the first item with the specified token and an expiration date that lies in the future from the users table.</p>
<p>There should only be one or no user coming back from this query, so we wrap this whole code in a try/catch block.</p>
<p>If a user has been found using this query, we will save his or hers email in the auth key of our session dictionary. If its the first time the user logs in, we set is_active to true for this database record.</p>
<p>We do this to keep our database clean. Imagine a hacker enters thousands of random email addresses into our beautiful sign in form and therefore creates thousands of records in our database. To keep our database clean, we can use this is_active column to delete all inactive database records periodically using cron jobs.</p>
<div id="verify-token" class="highlight"><span class="filename">#verify-token</span><pre><span></span><code><span class="nd">@rt</span><span class="p">(</span><span class="s1">&#39;/verify_magic_link/</span><span class="si">{token}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">get</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">token</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
   <span class="n">nowstr</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
   <span class="k">try</span><span class="p">:</span>
       <span class="n">user</span> <span class="o">=</span> <span class="n">users</span><span class="p">(</span><span class="s2">&quot;magic_link_token = ? AND magic_link_expiry &gt; ?&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">nowstr</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
       <span class="n">session</span><span class="p">[</span><span class="s1">&#39;auth&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">email</span>
       <span class="n">users</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">email</span><span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="p">,</span> <span class="n">magic_link_token</span><span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">magic_link_expiry</span><span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">is_active</span><span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
       <span class="k">return</span> <span class="n">RedirectResponse</span><span class="p">(</span><span class="s1">&#39;/dashboard&#39;</span><span class="p">)</span>
   <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
       <span class="k">return</span> <span class="s2">&quot;Invalid or expired magic link&quot;</span>
</code></pre></div>
<h3 id="beforeware-to-restrict-access">Beforeware to restrict access</h3>
<p>We need a page that is only accessible for authenticated users and a mechanism to restrict the access to this page for non-authenticated users. We will use FastHTMLs concept of beforeware for restricting access.</p>
<p>Here we define a function called before that takes in the request and saves whatever in the auth key of the session into the auth variable as well as the scope of the request. The request scope is something that comes from ASGI, the underlying webserver technology of FastHTML. Think of it as a kind of metadata or context of the request.</p>
<p>If there is nothing in session["auth"], auth will evaluate to False and we will redirect the user to the login page.</p>
<p>Then well define a Beforeware object with our newly defined before function. This will make sure that every request runs first through our function, unless its targeting one of the paths we define in the skip list. Everything else will be guarded by this Beforeware. Now we just need to pass our newly created Beforeware class to our fast_app function as the beforeware argument:</p>
<p>app, rt = fast_app(..., before=bware)</p>
<div id="auth-beforeware" class="highlight"><span class="filename">#auth-beforeware</span><pre><span></span><code><span class="n">login_redir</span> <span class="o">=</span> <span class="n">RedirectResponse</span><span class="p">(</span><span class="s1">&#39;/login&#39;</span><span class="p">,</span> <span class="n">status_code</span><span class="o">=</span><span class="mi">303</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">before</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">session</span><span class="p">):</span>
   <span class="n">auth</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">scope</span><span class="p">[</span><span class="s1">&#39;auth&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;auth&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
   <span class="k">if</span> <span class="ow">not</span> <span class="n">auth</span><span class="p">:</span> <span class="k">return</span> <span class="n">login_redir</span>

<span class="n">bware</span> <span class="o">=</span> <span class="n">Beforeware</span><span class="p">(</span><span class="n">before</span><span class="p">,</span> <span class="n">skip</span><span class="o">=</span><span class="p">[</span><span class="sa">r</span><span class="s1">&#39;/favicon\.ico&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;/static/.*&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;.*\.css&#39;</span><span class="p">,</span> <span class="s1">&#39;/login&#39;</span><span class="p">,</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="s1">&#39;/create_magic_link&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;/verify_magic_link/.*&#39;</span><span class="p">])</span>
</code></pre></div>
<div id="logout" class="highlight"><span class="filename">#logout</span><pre><span></span><code><span class="nd">@rt</span><span class="p">(</span><span class="s1">&#39;/logout&#39;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">post</span><span class="p">(</span><span class="n">session</span><span class="p">):</span>
    <span class="k">del</span> <span class="n">session</span><span class="p">[</span><span class="s1">&#39;auth&#39;</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">HttpHeader</span><span class="p">(</span><span class="s1">&#39;HX-Redirect&#39;</span><span class="p">,</span> <span class="s1">&#39;/login&#39;</span><span class="p">)</span>
</code></pre></div>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../..", "features": ["content.code.copy"], "search": "../../assets/javascripts/workers/search.d50fe291.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.13a4f30d.min.js"></script>
      
    
  </body>
</html>